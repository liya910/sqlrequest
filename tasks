-- 1. Количество неактивных клиентов с балансом > 100000
SELECT COUNT(*) AS inactive_rich_clients
FROM Clients
WHERE IsActive = 0 AND Balance > 100000;

-- 2. Средний кредитный рейтинг по странам
SELECT Country, AVG(CreditScore) AS average_credit_score
FROM Clients
GROUP BY Country;

-- 3. Процент ушедших клиентов по типу карты
SELECT CardType,
       ROUND(SUM(CASE WHEN Exited = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS churn_percentage
FROM Clients
GROUP BY CardType;

-- 4. Сравнение зарплаты клиента со средней по стране
SELECT ClientID, Country, Salary,
       AVG(Salary) OVER (PARTITION BY Country) AS avg_country_salary,
       Salary - AVG(Salary) OVER (PARTITION BY Country) AS difference
FROM Clients;

-- 5. Страны, где в топ-10 по зарплатам женщин больше, чем мужчин
WITH Top10Salaries AS (
    SELECT Country, Gender, Salary,
           ROW_NUMBER() OVER (PARTITION BY Country ORDER BY Salary DESC) AS rn
    FROM Clients
)
SELECT Country
FROM Top10Salaries
WHERE rn <= 10
GROUP BY Country
HAVING SUM(CASE WHEN Gender = 'Female' THEN 1 ELSE 0 END) >
       SUM(CASE WHEN Gender = 'Male' THEN 1 ELSE 0 END);

-- 6. Страны, в которых используются не все возможные типы карт
WITH CardTypes AS (
    SELECT DISTINCT CardType FROM Clients
),
CountryCardTypes AS (
    SELECT DISTINCT Country, CardType FROM Clients
),
CountryCardCount AS (
    SELECT Country, COUNT(DISTINCT CardType) AS country_card_count
    FROM CountryCardTypes
    GROUP BY Country
),
TotalCardCount AS (
    SELECT COUNT(*) AS total_card_types FROM CardTypes
)
SELECT ccc.Country
FROM CountryCardCount ccc, TotalCardCount tcc
WHERE ccc.country_card_count < tcc.total_card_types;
